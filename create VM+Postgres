###Создаем локальную сеть для тестов


https://console.cloud.yandex.ru/folders/b1gopjc957db2mmc5o4g

  Идентификатор
    fl8sfstg3riel9ansebt
  Статус
    Active
  Имя
    local-bda-64
  Описание
    Локальная сеть для тестов
  Зона
    ru-central1-d
  Сеть
    default
  IPv4 CIDR
    172.16.64.0/24
###Создаем ВМ

Имя 
  db-01
Описание
  Сервер базы данных 1


Диски и файловые хранилища
  30Гб
vCPu
  4

Внутренний IPv4-адрес
  Вручную
    172.16.64.20


Сервисный аккаунт
  borisov

Логин
  borisov
SSH-ключ
  ssh-key -t rsa -b 2048
  yc_key
##chmod 600 ~/.ssh/yc_key
chmod 600 yc_key.pub
  cat yc_key.pub
     Вставляем SSH-ключ
ssh -i yc_key borisov@158.160.146.141


apt update && sudo apt upgrade -y
apt-get install wget sudo curl gnupg2 -y
sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
apt -y update
apt-get install postgresql-15 -y
systemctl start postgresql
systemctl enable postgresql


systemctl status postgresql

Output
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)
     Active: active (exited)
   Main PID: 7543 (code=exited, status=0/SUCCESS)
      Tasks: 0 (limit: 2300)
     Memory: 0B
        CPU: 0
     CGroup: /system.slice/postgresql.service

ss -antpl | grep 5432

LISTEN 0      244        127.0.0.1:5432      0.0.0.0:*    users:(("postgres",pid=16671,fd=5))



sudo -u postgres psql -c "SELECT version();"
-------
 PostgreSQL 15.5 (Debian 15.5-1.pgdg110+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 10.2.1-6) 10.2.1 20210110, 64-bit
(1 row)


###Зайти вторым ssh (вторая сессия)
  borisov@db-01:~$ w
  08:35:19 up 4 min,  2 users,  load average: 0.02, 0.06, 0.02
  USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
  borisov  pts/0    109.252.67.118   08:33    1:34   0.00s  0.00s -bash
  borisov  pts/1    109.252.67.118   08:33    4.00s  0.00s  0.00s w

###Запустить везде psql из под пользователя postgres
  root@db-01:/home/borisov# su postgres
  postgres@db-01:/home/borisov$ psql
  psql (15.5 (Debian 15.5-1.pgdg110+1))
  Type "help" for help.

  postgres=#
  postgres=# CREATE DATABASE otus_db;
  CREATE DATABASE
  postgres=# 
  postgres=# create schema otus;
  CREATE SCHEMA


###Выключить auto commit
  postgres=# \set AUTOCOMMIT OFF
  postgres=# show transaction isolation level;
    transaction_isolation 
    -----------------------
    read committed
    (1 row)

  postgres=*# 

    сделать

###в первой сессии новую таблицу и наполнить ее данными create table persons(id serial, first_name text, second_name text); insert into persons(first_name, second_name) values('ivan', 'ivanov'); insert into persons(first_name, second_name) values('petr', 'petrov'); commit;
    create table otus.persons(id bigint generated by default as identity primary key, first_name text, second_name text);
    insert into otus.persons(first_name, second_name) values('ivan', 'ivanov'); insert into persons(first_name, second_name) values('petr', 'petrov'); commit;
###посмотреть текущий уровень изоляции: show transaction isolation level
    postgres=# show transaction isolation level;
    transaction_isolation 
    -----------------------
    read committed
    (1 row)
###начать новую транзакцию в обоих сессиях с дефолтным (не меняя) уровнем изоляции
    postgres=# select * from otus.persons p ;
     id | first_name | second_name 
    ----+------------+-------------
      1 | ivan       | ivanov
    (1 row)


###в первой сессии добавить новую запись insert into persons(first_name, second_name) values('sergey', 'sergeev');
    
    postgres=# insert into otus.persons(first_name, second_name) values('sergey', 'sergeev');
    INSERT 0 1
    postgres=*# select * from otus.persons p ;
     id | first_name | second_name 
    ----+------------+-------------
      1 | ivan       | ivanov
      2 | sergey     | sergeev
    (2 rows)

###сделать select from persons во второй сессии
    postgres=# select * from otus.persons p ;
     id | first_name | second_name 
    ----+------------+-------------
      1 | ivan       | ivanov
    (1 row)

    Видите ли вы новую запись и если да то почему?
Нет, изменения не были зафиксированы(не было commit); Режим без автофиксации неявно начинает транзакцию при первой выданной команде; изменения надо фиксировать самостоятельно. 

    завершить первую транзакцию - commit;
    сделать select from persons во второй сессии
    видите ли вы новую запись и если да то почему?
да, изменения были зафиксированы(commit);
    завершите транзакцию во второй сессии
    начать новые но уже repeatable read транзации - set transaction isolation level repeatable read;
    в первой сессии добавить новую запись insert into persons(first_name, second_name) values('sveta', 'svetova');
select * from otus.persons p ;
 id | first_name | second_name 
----+------------+-------------
  1 | ivan       | ivanov
  2 | sergey     | sergeev
(2 rows)

postgres=# set transaction isolation level repeatable read;
WARNING:  SET TRANSACTION can only be used in transaction blocks
SET
    сделать select* from persons во второй сессии*
    видите ли вы новую запись и если да то почему?
ДА?
    завершить первую транзакцию - commit;
    сделать select from persons во второй сессии
    видите ли вы новую запись и если да то почему?
    завершить вторую транзакцию
    сделать select * from persons во второй сессии
    видите ли вы новую запись и если да то почему? ДЗ сдаем в виде миниотчета в markdown в гите


        
